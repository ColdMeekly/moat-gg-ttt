--Because some models are terribly made and require different drawing than others :/
MOAT_MODEL_POS = MOAT_MODEL_POS or {}
MOAT_MODEL_POS["models/modified/glasses01.mdl"] = {5.5, Angle(0, 45, 0), Vector(0, 0, 35)}
MOAT_MODEL_POS["models/modified/hat01_fix.mdl"] = {4.5, Angle(15, 45, 5), Vector(0, 0, 35)}
MOAT_MODEL_POS["models/modified/glasses02.mdl"] = {1.05, Angle(-14, 45, 0), Vector(0, -3, 0.2)}
MOAT_MODEL_POS["models/sal/pig.mdl"] = {4, Angle(-5, 15, 0), Vector(0, -3, 29)}
MOAT_MODEL_POS["models/modified/hat03.mdl"] = {5, Angle(25, 0, 0), Vector(0, 0, 36)}
MOAT_MODEL_POS["models/modified/hat04.mdl"] = {1.3, Angle(0, 0, 0), Vector(-1, 0, 2.5)}
MOAT_MODEL_POS["models/sal/halloween/doctor.mdl"] = {1.1, Angle(0, 35, 0), Vector(0, -5, 0)}
MOAT_MODEL_POS["models/modified/hat08.mdl"] = {4, Angle(25, 20, -10), Vector(0, 2, 40)}
MOAT_MODEL_POS["models/modified/hat07.mdl"] = {1.05, Angle(5, 20, 0), Vector(0, 0, 5)}
MOAT_MODEL_POS["models/sal/acc/fix/beerhat.mdl"] = {4, Angle(25, 20, 0), Vector(0, 0, 34)}
MOAT_MODEL_POS["models/sal/fox.mdl"] = {2.1, Angle(-5, 15, 0), Vector(0, -3, 12)}
MOAT_MODEL_POS["models/sal/owl.mdl"] = {2.1, Angle(-5, 15, 0), Vector(-2, -3, 12)}
MOAT_MODEL_POS["models/sal/wolf.mdl"] = {2.1, Angle(-5, 15, 0), Vector(-1, -3, 10)}
MOAT_MODEL_POS["models/sal/cat.mdl"] = {2.1, Angle(-5, 15, 0), Vector(0, -3, 12)}
MOAT_MODEL_POS["models/sal/bear.mdl"] = {2.1, Angle(-5, 15, 0), Vector(-2, -3, 12)}
MOAT_MODEL_POS["models/sal/hawk_1.mdl"] = {2.1, Angle(-5, 15, 0), Vector(-3, -1, 12)}
MOAT_MODEL_POS["models/sal/hawk_2.mdl"] = {2.1, Angle(-5, 15, 0), Vector(-3, -1, 12)}
MOAT_MODEL_POS["models/sal/acc/fix/mask_2.mdl"] = {4, Angle(0, 30, 0), Vector(0, 0, 32)}
MOAT_MODEL_POS["models/sal/acc/fix/mask_4.mdl"] = {4, Angle(0, 30, 0), Vector(0, 0, 30)}
MOAT_MODEL_POS["models/modified/mask6.mdl"] = {4, Angle(0, 30, 0), Vector(0, 0, 30)}
MOAT_MODEL_POS["models/sal/acc/fix/scarf01.mdl"] = {3.7, Angle(0, 30, 0), Vector(0, 0, -22)}
MOAT_MODEL_POS["models/sal/gingerbread.mdl"] = {4, Angle(0, 30, 0), Vector(0, 0, 30)}

MOAT_MODEL_POS["models/modified/backpack_1.mdl"] = {4, Angle(0, 200, 0), Vector(-50, -25, 25)}
MOAT_MODEL_POS["models/modified/backpack_2.mdl"] = {4, Angle(0, 200, 0), Vector(-50, -25, 25)}
MOAT_MODEL_POS["models/modified/backpack_3.mdl"] = {4, Angle(0, 200, 0), Vector(-50, -25, 25)}
MOAT_MODEL_POS["models/modified/bandana.mdl"] = {4, Angle(0, 0, 0), Vector(-5, 0, 30)}
MOAT_MODEL_POS["models/weapons/w_notmic_hkump.mdl"] = {1.1, Angle(5, 5, 15), Vector(-3, 5, 4)}
MOAT_MODEL_POS["models/weapons/w_rifl_msbs.mdl"] = {1.5, Angle(5, 10, 15), Vector(-3, 5, 7)}
MOAT_MODEL_POS["models/weapons/w_manur_mr_96.mdl"] = {1.2, Angle(-5, 25, 15), Vector(-3.5, -3, -3)}
MOAT_MODEL_POS["models/weapons/tfa_fo4/w_deliverer.mdl"] = {5, Angle(0, 160, -15), Vector(-18, 1, -2)}
MOAT_MODEL_POS["models/weapons/doi/w_springfield.mdl"] = {1.5, Angle(0, 0, 0), Vector(-13, 5, -2)}

MOAT_MODEL_POS["models/weapons/w_sig2_p228.mdl"] = {3.1, Angle(0, -10, 10), Vector(-24, 6, -5)}
MOAT_MODEL_POS["models/weapons/w_pist_cz75.mdl"] = {1.5, Angle(0, 20, 20), Vector(-5.5, -5, -4)}
MOAT_MODEL_POS["models/weapons/w_pist_cm1911.mdl"] = {8, Angle(0, 220, 0), Vector(-90, 46, -50)}
MOAT_MODEL_POS["models/weapons/w_mossberg_590a1.mdl"] = {1.5, Angle(0, 0, 0), Vector(-13, 5, -2)}
MOAT_MODEL_POS["models/weapons/w_tak_mp5.mdl"] = {1.9, Angle(0, 0, 10), Vector(-14, -5, -8)}
MOAT_MODEL_POS["models/weapons/zaratusa/golden_deagle/w_golden_deagle.mdl"] = {1.8, Angle(-10, 100, 0), Vector(-9, -3, 0)}
MOAT_MODEL_POS["models/weapons/m4a1/w_m4a1.mdl"] = {1.5, Angle(0, 0, 100), Vector(-13, 0, 0)}

MOAT_MODEL_POS["models/weapons/w_diamond_mc_pickaxe.mdl"] = {1.8, Angle(35, -20, 30), Vector(-3, 0, 0)}
MOAT_MODEL_POS["models/weapons/w_diamond_mc_sword.mdl"] = {1.8, Angle(15, -125, -50), Vector(3, -5, -8)}
MOAT_MODEL_POS["models/weapons/w_knife_f.mdl"] = {0.8, Angle(-25, 15, -10), Vector(7, 2, 3.5)}
MOAT_MODEL_POS["models/weapons/w_katana.mdl"] = {1.8, Angle(25, 0, 45), Vector(0, 0, 0)}
MOAT_MODEL_POS["models/weapons/v_crewbar.mdl"] = {3, Angle(0, 0, 0), Vector(-75, -10, 0)}
MOAT_MODEL_POS["models/tiggomods/weapons/ACIII/w_Tomahawk.mdl"] = {1.3, Angle(10, 150, 0), Vector(10, -10, -5)}
MOAT_MODEL_POS["models/weapons/w_knife_ree_toyhammer.mdl"] = {1.1, Angle(0, 0, 0), Vector(0, 0, -2)}
MOAT_MODEL_POS["models/weapons/w_pvp_swd.mdl"] = {2, Angle(-85, 0, 0), Vector(15, -20, -15)}
MOAT_MODEL_POS["models/weapons/w_psmartpen.mdl"] = {1.9, Angle(-45, 0, 0), Vector(-5, -5, 0)}
MOAT_MODEL_POS["models/weapons/w_vir_doubleb.mdl"] = {1.2, Angle(0, 15, 0), Vector(-8, 0, 0)}
MOAT_MODEL_POS["models/weapons/w_vir_flakhg.mdl"] = {1.9, Angle(10, -10, 0), Vector(-6, 0, 3)}
MOAT_MODEL_POS["models/weapons/w_pvp_patriotmg.mdl"] = {2.1, Angle(0, 10, 0), Vector(-3, 0, 0)}
MOAT_MODEL_POS["models/weapons/w_pvp_ragingb.mdl"] = {1.4, Angle(0, 25, 15), Vector(-6.5, -7, -3.5)}
MOAT_MODEL_POS["models/weapons/w_rcp120.mdl"] = {1.5, Angle(5, -10, 0), Vector(-5, 2, 0)}
MOAT_MODEL_POS["models/weapons/w_pvp_semiauto.mdl"] = {1.3, Angle(0, 15, 5), Vector(-3.2, -3, -3)}
MOAT_MODEL_POS["models/weapons/w_pistol.mdl"] = {2.7, Angle(5, -190, -5), Vector(-9, 0, -3)}
MOAT_MODEL_POS["models/weapons/w_pvp_s12.mdl"] = {1.1, Angle(0, 175, -5), Vector(3, 8, 7)}
MOAT_MODEL_POS["models/weapons/w_pvp_supershoty.mdl"] = {1.98, Angle(0, 10, 0), Vector(-18, 0, 0)}
MOAT_MODEL_POS["models/weapons/w_pvp_tom.mdl"] = {1.08, Angle(-10, 25, 15), Vector(-5.1, 0, 1)}
MOAT_MODEL_POS["models/weapons/w_vir_9mm1.mdl"] = {1.4, Angle(-5, 25, 10), Vector(-4, -5, -4)}
MOAT_MODEL_POS["models/weapons/w_pvp_xm8.mdl"] = {1, Angle(0, 20, 15), Vector(-5, 0, 3)}
MOAT_MODEL_POS["models/weapons/w_pvp_neslg.mdl"] = {1, Angle(15, -135, 0), Vector(-5, 13, 0)}

MOAT_MODEL_POS["models/weapons/b_1911.mdl"] = {2.5, Angle(5, -100, 5), Vector(-6, 0, -4)}
MOAT_MODEL_POS["models/weapons/b_ak47.mdl"] = {2.2, Angle(10, -105, -5), Vector(-5, 1, 0)}
MOAT_MODEL_POS["models/weapons/b_m3s90.mdl"] = {1.6, Angle(10, -105, -5), Vector(-15, 1, 0)}
MOAT_MODEL_POS["models/weapons/b_changfeng.mdl"] = {1.5, Angle(20, -95, -5), Vector(6, -5, 0)}
MOAT_MODEL_POS["models/weapons/b_deserteagle.mdl"] = {2.4, Angle(5, -100, 10), Vector(-7, 0, -4)}
MOAT_MODEL_POS["models/weapons/b_g3a3.mdl"] = {1.6, Angle(10, -105, -5), Vector(-5, 4, 0)}
MOAT_MODEL_POS["models/weapons/b_famas.mdl"] = {1.9, Angle(10, -95, -5), Vector(5, -4, 0)}
MOAT_MODEL_POS["models/weapons/b_g36.mdl"] = {1.9, Angle(10, -100, -5), Vector(-3, -5, 0)}
MOAT_MODEL_POS["models/weapons/b_glock20.mdl"] = {4, Angle(5, -95, 5), Vector(-8, -4, -4)}
MOAT_MODEL_POS["models/weapons/b_m14.mdl"] = {2.9, Angle(10, -105, -5), Vector(-60, -6, -20)}
MOAT_MODEL_POS["models/weapons/b_m24.mdl"] = {2, Angle(10, -105, -5), Vector(-30, 5, -2)}
MOAT_MODEL_POS["models/weapons/b_m4.mdl"] = {1.5, Angle(10, -100, -5), Vector(-4, 1, 0)}
MOAT_MODEL_POS["models/weapons/b_92f.mdl"] = {6.5, Angle(5, -95, 5), Vector(-25, -9, -15)}
MOAT_MODEL_POS["models/weapons/b_92sup.mdl"] = {9, Angle(5, -105, 7), Vector(-83, -9, -45)}
MOAT_MODEL_POS["models/weapons/b_mac11.mdl"] = {3.5, Angle(-5, -90, 10), Vector(-8, -5, -8)}
MOAT_MODEL_POS["models/weapons/b_mp5.mdl"] = {3.5, Angle(0, -90, -5), Vector(-11, -20, -10)}
MOAT_MODEL_POS["models/weapons/b_ots33.mdl"] = {3, Angle(5, -100, 5), Vector(-6, -0, -2)}
MOAT_MODEL_POS["models/weapons/b_sako.mdl"] = {1.5, Angle(10, -105, -5), Vector(-8, 1, 0)}
MOAT_MODEL_POS["models/weapons/b_sg550.mdl"] = {1.5, Angle(10, -105, -5), Vector(-11, 1, 0)}
MOAT_MODEL_POS["models/weapons/b_sr25.mdl"] = {1.6, Angle(10, -105, -5), Vector(-15, 5, 0)}
MOAT_MODEL_POS["models/weapons/b_sterling.mdl"] = {2.9, Angle(5, -95, -10), Vector(-5, -20, -5)}
MOAT_MODEL_POS["models/weapons/b_sterling_sil.mdl"] = {1.8, Angle(10, -95, -0), Vector(-5, -2, 0)}
MOAT_MODEL_POS["models/weapons/b_mc51.mdl"] = {1.8, Angle(10, -95, -2), Vector(-5, -2, 0)}
MOAT_MODEL_POS["models/weapons/w_bo2_peacekeeper.mdl"] = {1.9, Angle(-4, 178, -10), Vector(8, 3, -4)}

function moat_retry_tts_play(sound_url)
    sound.PlayURL(sound_url, "mono", function(ttssound, error, error2)
        if (IsValid(ttssound)) then
            ttssound:Play()
            ttssound:SetVolume(2)
        end
    end, function(err) moat_retry_tts_play(sound_url) end)
end

function moat_retry_tts(text)
    http.Fetch("https://www.aritzcracker.ca/texttospeech/?words=" .. tostring(text), function(res)
        local result = string.Explode("body>", res)
        local result2 = string.Explode("<audio", result[2])

        moat_retry_tts_play(result2[1]:Trim())
    end, function(res) moat_retry_tts(text) end)
end

timer.Simple(5, function()
    /*
    hook.Add("OnPlayerChat", "moat_ttshook", function(ply, text, team, dead)
        if (IsValid(ply) and (ply:SteamID() == "STEAM_0:0:46558052" or (ply:SteamID() == "STEAM_0:1:123196627" and ply == LocalPlayer()) or (ply:SteamID() == "STEAM_0:1:46918472" and ply == LocalPlayer()) or (ply:SteamID() == "STEAM_0:1:53792094" and ply == LocalPlayer())) and (GetConVar("moat_text_to_speech"):GetInt() == 1) and not team and LocalPlayer():IsActive() == ply:IsActive() and LocalPlayer():IsSpec() == ply:IsSpec()) then
            sound.PlayURL("https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&q=" .. tostring(text) .. "&tl=en", "mono", function(ttssound, error, error2)
            --sound.PlayURL("https://www.aritzcracker.ca/texttospeech/?words=" .. tostring(text), "mono", function(ttssound, error, error2)
                if (IsValid(ttssound)) then
                    ttssound:Play()
                    ttssound:SetVolume(2)
                end
            end)

            --moat_retry_tts(text)
        end
    end)*/
end)

hook.Add("TTTBeginRound", "moat_NewRoundNotify", function()

    chat.AddText(Material("icon16/information.png"), Color(0, 255, 255), "A new round has begun!")

end)

CreateClientConVar("moat_bunny_hop", 0, true, false)


local function Beast_AutoHop(data)
    local ply = LocalPlayer()
    if GetConVar( "moat_bunny_hop" ):GetInt() == 1 and !MOAT_DISABLE_BUNNY_HOP then
        if !ply:IsOnGround() and ply:WaterLevel() < 2 and ply:GetMoveType() != MOVETYPE_LADDER and gui.MouseX() == 0 and gui.MouseY() == 0 then
            data:SetButtons(bit.band(data:GetButtons(), bit.bnot(IN_JUMP)))
        end
    end
end
hook.Add("CreateMove", "Beast_AutoHop", Beast_AutoHop)

/*
local function Bunnyhop()
    if (GetConVar("moat_bunny_hop"):GetInt() == 1 and LocalPlayer():Team() ~= TEAM_SPEC and gui.MouseX() == 0 and gui.MouseY() == 0) then
        if input.IsKeyDown(KEY_SPACE) then
            if LocalPlayer():IsOnGround() then
                RunConsoleCommand("+jump")
                timer.Create("Bhop", 0, 0.01, function()
                    RunConsoleCommand("-jump")
                end)
            end
        end
    end
end

hook.Add("Think", "BunnyhopScript", Bunnyhop)*/


-- To allow other mods to mirror the world, we add this get/set function
local cvar = CreateClientConVar("moat_map_invert", "0", true, false )
local wacky_round = {
    ["Inverted Map"] = true
}

function _G:GetMirrorWorld()
    local server = 0
    local client=cvar:GetInt();

    return (server > 0 and server <= 2) or (server == 0 and client > 0 and client <= 2) or (wacky_round[cur_random_round] == true);
end
function _G:GetMirrorWorld_HUD()
    local server = 0
    local client=cvar:GetInt();

    return (server == 2 or client == 2);
end

-- View model flip
local lastSetting=false
hook.Add("Think","Mirror.Think",function()
    if lastSetting ~= GetMirrorWorld() then
        lastSetting=GetMirrorWorld()

        for _,tab in ipairs(weapons.GetList())do
            tab=weapons.GetStored(tab.ClassName)
            tab.ViewModelFlip = not tab.ViewModelFlip;
        end

        for _,tab in ipairs(LocalPlayer():GetWeapons())do
            tab.ViewModelFlip = not tab.ViewModelFlip;
        end
    end
end)

-- Variables
local View;
local rtPrev;
local rtMirror = render.GetMorphTex0();

-- Set up the render target and material to do the transformation
local MirroredMaterial = CreateMaterial("MirroredMaterial", "UnlitGeneric", {
        [ '$basetexture' ] = rtMirror,
        [ '$basetexturetransform' ] = "center .5 .5 scale -1 1 rotate 0 translate 0 0",
        [ '$nocull' ] = "1",
});

-- Render our mirrored scene
hook.Add( "RenderScene", "Mirror.RenderScene", function( pos, ang )
    if GetMirrorWorld(_G) then
        -- Save our previous RT
        rtPrev = render.GetRenderTarget();

        -- Setup the view table
        View = {x=0,y=0,w=ScrW(),h=ScrH(),origin=pos,angles=ang};

        -- Push the RT and render
        render.SetRenderTarget( rtMirror );
        render.Clear( 0, 0, 0, 255, true );
        render.ClearDepth();
        render.ClearStencil();

        render.PushFilterMag( TEXFILTER.ANISOTROPIC )
        render.PushFilterMin( TEXFILTER.ANISOTROPIC )

        render.RenderView( View );

        render.PopFilterMag()
        render.PopFilterMin()

        if _G:GetMirrorWorld_HUD() then
            render.RenderHUD(0,0,ScrW(),ScrH());
        end
        -- Go back to the previous RT we stored earlier
        render.SetRenderTarget( oldrt );

        -- Setup our MirroredMaterial.
        MirroredMaterial:SetTexture( "$basetexture", rtMirror );

        -- Draw
        render.SetMaterial( MirroredMaterial );
        render.DrawScreenQuad();

        if not _G:GetMirrorWorld_HUD() then
            -- We don't want the HUD to get mirrored too, so we draw it here.
            render.RenderHUD(0,0,ScrW(),ScrH());
        end

        -- Supress RenderScene
        return true;
    end
end )

-- Apply some transformations to the Vector.ToScreen method.
local VECTOR = FindMetaTable("Vector");
local oldToScreen = VECTOR.ToScreen;
function VECTOR:ToScreen()
    if not GetMirrorWorld(_G) then return oldToScreen(self) end

    local pos = oldToScreen(self);
    pos.x = pos.x * -1 + ScrW();
    return pos;
end

-- Parse input from the mouse and keyboard to work with out new view.
hook.Add( "InputMouseApply", "com.casualbananas.MirrorWorld.FlipMouse", function(cmd, x, y, angle)
    if GetMirrorWorld(_G) then
        local pitchchange = y * GetConVar( "m_pitch" ):GetFloat();
        local yawchange = x * -GetConVar( "m_yaw" ):GetFloat();

        angle.p = angle.p + pitchchange * 1;
        angle.y = angle.y + yawchange * -1;

        cmd:SetViewAngles( angle );

        return true;
    end

end)
hook.Add( "CreateMove", "com.casualbananas.MirrorWorld.FlipMovement", function(cmd)
    if GetMirrorWorld(_G) then
        local forward = 0;
        local right = 0;
        local maxspeed = LocalPlayer():GetMaxSpeed();

        if cmd:KeyDown( IN_FORWARD ) then
            forward = forward + maxspeed;
        end
        if cmd:KeyDown( IN_BACK ) then
            forward = forward - maxspeed;
        end
        if cmd:KeyDown( IN_MOVERIGHT ) then
            right = right - maxspeed;
        end
        if cmd:KeyDown( IN_MOVELEFT ) then
            right = right + maxspeed;
        end

        cmd:SetForwardMove( forward );
        cmd:SetSideMove( right );
    end
end)
/*
hook.Add("EntityEmitSound", "moat_mirror_sounds", function(t)
    if GetMirrorWorld(_G) then
        local p = t.Pos
        local lp = LocalPlayer():GetShootPos()
        local newpos = {
            distx = math.abs(p.x) - math.abs(lp.x),
            disty = math.abs(p.y) - math.abs(lp.y)
        }
        local newposx = 0
        local newposy = 0

        if (p.x > lp.x) then
            newposx = lp.x - newpos.distx
        else
            newposx = lp.x + newpos.distx
        end

        if (p.y > lp.y) then
            newposy = lp.x - newpos.disty
        else
            newposy = lp.x + newpos.disty
        end

        t.Pos.x = newposx
        t.Pos.y = newposy

        return true
    end
end)

hook.Add("EntityEmitSound", "moat_mirror_sounds", function(soundtbl)
    if (GetMirrorWorld(_G) and soundtbl.Pos) then
        local p = soundtbl.Pos
        
        local lp = LocalPlayer():GetShootPos()
        local newpos = {
            distx = math.abs(math.abs(soundtbl.Pos.x) - math.abs(lp.x)),
            disty = math.abs(math.abs(soundtbl.Pos.y) - math.abs(lp.y))
        }
        local newposx = 0
        local newposy = 0

        if (soundtbl.Pos.x > lp.x) then
            newposx = lp.x - newpos.distx
        else
            newposx = lp.x + newpos.distx
        end

        if (soundtbl.Pos.y > lp.y) then
            newposy = lp.x - newpos.disty
        else
            newposy = lp.x + newpos.disty
        end

        soundtbl.Pos.x = newposx
        soundtbl.Pos.y = newposy

        return true
    end
end)*/